<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nmediaservices Stockflow | Premium Footage Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-card:hover img { transform: scale(1.05); }
        .modal-hidden { display: none; }
        .modal-visible { display: flex; }
        .category-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        .category-btn.active { 
            background: #14B8A6;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.3);
        }
        .category-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #14B8A6;
            border-radius: 2px;
        }
        .subcategory-btn.active {
            background: #0D9488;
            color: white;
            box-shadow: 0 2px 4px rgba(13, 148, 136, 0.3);
        }
        .format-btn.active {
            background: #14B8A6;
            color: white;
        }
        .subcategory-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="./assets/logo.png" 
                     alt="Nmediaservices Logo" 
                     class="h-10 w-auto max-w-[150px]"
                     onerror="this.style.display='none'">
                <h1 class="text-xl font-bold tracking-tight text-gray-900">Nmediaservices<span class="text-teal-500">Stockflow</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <a href="#" class="text-sm font-medium text-gray-600 hover:text-teal-600 transition">Explore</a>
                <a href="#" class="text-sm font-medium text-gray-600 hover:text-teal-600 transition">License</a>
                <a href="#" class="text-sm font-medium text-gray-600 hover:text-teal-600 transition">About</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section with Search -->
    <header class="bg-gradient-to-br from-teal-500 to-teal-700 text-white py-20 px-6">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-5xl font-extrabold mb-4 tracking-tight">Premium Stock Footage</h2>
            <p class="text-xl text-teal-100 mb-8">Discover high-quality videos for your creative projects</p>
            
            <!-- Search Bar -->
            <div class="relative max-w-2xl mx-auto">
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Search footage by title, description, or tags..."
                    class="w-full px-6 py-4 pr-32 rounded-full text-gray-900 text-lg focus:outline-none focus:ring-4 focus:ring-teal-300 shadow-xl"
                    oninput="filterVideos()">
                <button class="absolute right-2 top-2 bg-teal-600 text-white px-8 py-2 rounded-full font-semibold hover:bg-teal-700 transition">
                    Search
                </button>
            </div>
        </div>
    </header>

    <!-- Filters Section -->
    <div class="bg-white border-b border-gray-200 sticky top-[73px] z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <!-- Main Categories -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm font-bold text-gray-700 uppercase tracking-wide">Browse Categories</p>
                    <p class="text-xs text-gray-500" id="resultCount">Loading...</p>
                </div>
                <div class="flex flex-wrap gap-2" id="categoryButtons">
                    <!-- Categories will be auto-generated from sheet data -->
                </div>
            </div>

            <!-- Subcategories Section (appears when category selected) -->
            <div id="subcategorySection" class="mb-4 hidden">
                <div class="bg-teal-50 border border-teal-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-4 h-4 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="text-sm font-semibold text-teal-800" id="subcategoryTitle">Subcategories</p>
                    </div>
                    <div class="flex flex-wrap gap-2" id="subcategoryButtons">
                        <!-- Subcategories will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Format & Sort Filters -->
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide">Format</p>
                    <div class="flex gap-2">
                        <button class="format-btn active px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-teal-500 hover:text-white transition" 
                                data-format="all" onclick="filterByFormat('all')">
                            All
                        </button>
                        <button class="format-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-teal-500 hover:text-white transition" 
                                data-format="9:16" onclick="filterByFormat('9:16')">
                            üì± 9:16
                        </button>
                        <button class="format-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-teal-500 hover:text-white transition" 
                                data-format="16:9" onclick="filterByFormat('16:9')">
                            üñ•Ô∏è 16:9
                        </button>
                        <button class="format-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-teal-500 hover:text-white transition" 
                                data-format="1:1" onclick="filterByFormat('1:1')">
                            ‚¨ú 1:1
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div class="max-w-7xl mx-auto px-6 py-4">
        <p id="status-text" class="text-sm text-gray-500">
            <span class="inline-block w-2 h-2 bg-teal-500 rounded-full animate-pulse mr-2"></span>
            Loading footage...
        </p>
    </div>

    <!-- Video Grid -->
    <main class="max-w-7xl mx-auto px-6 pb-16">
        <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>
        
        <!-- Load More Button -->
        <div id="loadMoreSection" class="text-center mt-8 hidden">
            <button onclick="loadMore()" class="bg-teal-500 text-white px-8 py-3 rounded-xl font-semibold hover:bg-teal-600 transition">
                Load More
            </button>
        </div>
    </main>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal-hidden fixed inset-0 bg-black/95 z-[60] items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl overflow-hidden max-w-5xl w-full shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 z-50 bg-black/70 text-white rounded-full p-2.5 hover:bg-black transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <video id="modalVideo" controls class="w-full aspect-video bg-black" src=""></video>
            
            <div class="p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <div class="flex-1">
                        <h3 id="modalTitle" class="text-2xl font-bold text-gray-900 mb-2">Video Title</h3>
                        <div class="flex items-center gap-2 text-sm flex-wrap mb-2">
                            <span id="modalCategory" class="px-3 py-1 bg-teal-100 text-teal-700 rounded-lg font-medium">Category</span>
                            <span id="modalSubcategory" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg font-medium">Subcategory</span>
                            <span id="modalFormat" class="text-gray-600">16:9</span>
                            <span id="modalResolution" class="text-gray-600">4K</span>
                        </div>
                        <!-- Tags display -->
                        <div id="modalTags" class="flex flex-wrap gap-1 mt-2"></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">License from</p>
                            <p class="text-3xl font-bold text-gray-900">$<span id="modalPrice">10</span></p>
                        </div>
                        <button onclick="handlePurchase()" class="bg-teal-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-teal-600 transition shadow-lg shadow-teal-200">
                            Buy Now
                        </button>
                    </div>
                </div>
                <p id="modalDescription" class="text-gray-600 text-sm"></p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const PUBLISHED_SHEET_ID = '2PACX-1vSP5OJpICPPpGYxgeuVcpJdx8nR7LKqLTpDAWBlhLKUgZDafXqZ_tTpa8_1fM1bVHdBYGlorZxfiW8_';
        const SHEET_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_SHEET_ID}/pub?output=csv`;

        let allVideos = [];
        let filteredVideos = [];
        let displayedVideos = [];
        let currentCategory = 'all';
        let currentSubcategory = 'all';
        let currentFormat = 'all';
        let currentVideo = null;
        let displayCount = 0;
        const ITEMS_PER_LOAD = 100;

        // Track unique categories and subcategories
        let categories = new Set();
        let subcategories = {};

        // CSV Parser
        function parseCSV(text) {
            const lines = text.split('\n');
            const result = [];
            
            for (let line of lines) {
                if (!line.trim()) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                result.push(values);
            }
            
            return result;
        }

        async function init() {
            const grid = document.getElementById('video-grid');
            const status = document.getElementById('status-text');

            try {
                console.log('üîÑ Fetching from:', SHEET_CSV_URL);
                const response = await fetch(SHEET_CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const csvText = await response.text();
                const rows = parseCSV(csvText);

                console.log('‚úÖ Received', rows.length - 1, 'rows');

                // Parse data - FIXED COLUMN MAPPING
                allVideos = [];
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    
                    if (!row || row.length < 2 || !row[1]) continue;

                    const video = {
                        id: row[0] || i.toString(),              // A: File_ID
                        title: row[1] || "Untitled",             // B: Title
                        category: row[2] || "Uncategorized",     // C: Category
                        subcategory: row[3] || "",               // D: Catagory_Sub
                        description: row[4] || "",               // E: Description
                        thumb: row[5] || "",                     // F: Thumbnail_URL
                        preview: row[6] || "",                   // G: Preview_URL
                        price: row[7] || "25",                   // H: Price
                        format: row[8] || "16:9",                // I: Format
                        resolution: row[9] || "4K",              // J: Resolution
                        tags: row[10] || ""                      // K: Tags
                    };
                    
                    // Debug: Log first video to console
                    if (i === 1) {
                        console.log('üìπ First video data:', video);
                        console.log('üñºÔ∏è Thumbnail URL:', video.thumb);
                        console.log('üé¨ Preview URL:', video.preview);
                    }

                    // Track categories
                    if (video.category) {
                        categories.add(video.category);
                        
                        if (video.subcategory) {
                            if (!subcategories[video.category]) {
                                subcategories[video.category] = new Set();
                            }
                            subcategories[video.category].add(video.subcategory);
                        }
                    }

                    allVideos.push(video);
                }

                // Reverse order for "New Arrivals" (latest first)
                allVideos.reverse();

                // Generate category buttons
                generateCategoryButtons();

                filteredVideos = [...allVideos];
                displayCount = 0;
                renderVideos(true);

                status.innerHTML = `<span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>${allVideos.length} videos loaded`;

            } catch (error) {
                console.error("‚ùå Error:", error);
                status.innerHTML = `<span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-2"></span>Failed to load footage`;
                
                grid.innerHTML = `
                    <div class="col-span-full bg-red-50 border border-red-200 rounded-xl p-8 text-center">
                        <h3 class="text-red-800 font-bold text-lg mb-2">Connection Error</h3>
                        <p class="text-red-600 text-sm mb-4">Unable to load videos from Google Sheets.</p>
                        <p class="text-red-600 text-xs font-mono">${error.message}</p>
                    </div>
                `;
            }
        }

        function generateCategoryButtons() {
            const container = document.getElementById('categoryButtons');
            container.innerHTML = '';

            // Add "New Arrivals" button first
            const newArrivalsBtn = document.createElement('button');
            newArrivalsBtn.className = 'category-btn active px-5 py-2.5 rounded-full text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-teal-500 hover:text-white transition shadow-sm';
            newArrivalsBtn.setAttribute('data-category', 'all');
            newArrivalsBtn.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                    </svg>
                    <span>New Arrivals</span>
                </div>
            `;
            newArrivalsBtn.onclick = () => filterByCategory('all');
            container.appendChild(newArrivalsBtn);

            // Add category buttons from data
            const sortedCategories = Array.from(categories).sort();
            sortedCategories.forEach(cat => {
                const btn = document.createElement('button');
                const subcatCount = subcategories[cat] ? subcategories[cat].size : 0;
                
                btn.className = 'category-btn px-5 py-2.5 rounded-full text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-teal-500 hover:text-white transition shadow-sm';
                btn.setAttribute('data-category', cat);
                btn.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${cat}</span>
                        ${subcatCount > 0 ? `<span class="text-xs opacity-60">(${subcatCount})</span>` : ''}
                    </div>
                `;
                btn.onclick = () => filterByCategory(cat);
                container.appendChild(btn);
            });

            console.log('‚úÖ Generated', categories.size, 'category buttons');
        }

        function renderVideos(reset = false) {
            const grid = document.getElementById('video-grid');
            const loadMoreSection = document.getElementById('loadMoreSection');
            
            if (reset) {
                grid.innerHTML = '';
                displayCount = 0;
            }

            if (filteredVideos.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
                        </svg>
                        <p class="text-gray-400 text-lg">No videos match your filters</p>
                        <button onclick="resetFilters()" class="mt-4 text-teal-600 hover:text-teal-700 font-medium">Reset Filters</button>
                    </div>
                `;
                loadMoreSection.classList.add('hidden');
                return;
            }

            const endIndex = Math.min(displayCount + ITEMS_PER_LOAD, filteredVideos.length);
            const videosToShow = filteredVideos.slice(displayCount, endIndex);

            videosToShow.forEach((video, idx) => {
                const card = document.createElement('div');
                card.className = "video-card bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all cursor-pointer group";
                
                // Debug logging for first video
                if (displayCount === 0 && idx === 0) {
                    console.log('üé¨ Rendering first video:', video.title);
                    console.log('üñºÔ∏è Thumbnail URL:', video.thumb);
                    console.log('üìπ Preview URL:', video.preview);
                }
                
                card.innerHTML = `
                    <div class="relative aspect-video bg-gray-100 overflow-hidden">
                        <img src="${video.thumb}" 
                             class="w-full h-full object-cover transition-transform duration-500" 
                             alt="${video.title}"
                             loading="lazy"
                             onerror="handleImageError(this, '${video.title}', '${video.thumb}')">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="bg-white/95 p-4 rounded-full shadow-xl">
                                <svg class="w-8 h-8 text-teal-500 ml-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="absolute top-2 right-2 px-2 py-1 bg-black/70 text-white text-xs font-semibold rounded">
                            ${video.format}
                        </div>
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-gray-800 text-base mb-2 line-clamp-1">${video.title}</h4>
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="text-xs text-teal-600 font-semibold uppercase tracking-wide">${video.category}</span>
                                ${video.subcategory ? `<span class="text-[10px] text-gray-500">${video.subcategory}</span>` : ''}
                            </div>
                            <span class="font-bold text-gray-900 text-lg">$${video.price}</span>
                        </div>
                    </div>
                `;

                card.onclick = () => openModal(video);
                grid.appendChild(card);
            });

            displayCount = endIndex;

            // Show/hide load more button
            if (displayCount < filteredVideos.length) {
                loadMoreSection.classList.remove('hidden');
            } else {
                loadMoreSection.classList.add('hidden');
            }
        }

        function handleImageError(img, title, url) {
            console.error('‚ùå Image failed to load:', {
                title: title,
                url: url,
                error: 'Failed to load thumbnail'
            });
            
            // Show placeholder with title
            img.src = `https://placehold.co/600x400/14B8A6/FFFFFF?text=${encodeURIComponent(title)}`;
            img.alt = `Placeholder for ${title}`;
        }

        function resetFilters() {
            currentCategory = 'all';
            currentSubcategory = 'all';
            currentFormat = 'all';
            document.getElementById('searchInput').value = '';
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === 'all') {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-format') === 'all') {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById('subcategorySection').classList.add('hidden');
            
            applyFilters();
        }

        function loadMore() {
            renderVideos(false);
        }

        function filterByCategory(category) {
            currentCategory = category;
            currentSubcategory = 'all';
            
            // Update category button states
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Handle subcategories display
            const subcatSection = document.getElementById('subcategorySection');
            const subcatButtons = document.getElementById('subcategoryButtons');
            const subcatTitle = document.getElementById('subcategoryTitle');
            
            if (category !== 'all' && subcategories[category] && subcategories[category].size > 0) {
                // Show subcategories with animation
                subcatSection.classList.remove('hidden');
                subcatSection.classList.add('subcategory-slide-in');
                subcatTitle.textContent = `${category} Subcategories`;
                subcatButtons.innerHTML = '';
                
                // Add "All" button for subcategories
                const allBtn = document.createElement('button');
                allBtn.className = 'subcategory-btn active px-4 py-2 rounded-lg text-xs font-semibold bg-white text-gray-700 hover:bg-teal-600 hover:text-white transition border border-teal-300';
                allBtn.innerHTML = `
                    <div class="flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>All ${category}</span>
                    </div>
                `;
                allBtn.onclick = () => filterBySubcategory('all');
                subcatButtons.appendChild(allBtn);
                
                // Add subcategory buttons
                const sortedSubcats = Array.from(subcategories[category]).sort();
                sortedSubcats.forEach(subcat => {
                    const btn = document.createElement('button');
                    btn.className = 'subcategory-btn px-4 py-2 rounded-lg text-xs font-semibold bg-white text-gray-700 hover:bg-teal-600 hover:text-white transition border border-teal-200';
                    btn.textContent = subcat;
                    btn.onclick = () => filterBySubcategory(subcat);
                    subcatButtons.appendChild(btn);
                });
            } else {
                // Hide subcategories section
                subcatSection.classList.add('hidden');
                subcatSection.classList.remove('subcategory-slide-in');
            }
            
            applyFilters();
        }

        function filterBySubcategory(subcategory) {
            currentSubcategory = subcategory;
            
            document.querySelectorAll('.subcategory-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function filterByFormat(format) {
            currentFormat = format;
            
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function filterVideos() {
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredVideos = allVideos.filter(video => {
                const matchesCategory = currentCategory === 'all' || 
                    video.category === currentCategory;
                
                const matchesSubcategory = currentSubcategory === 'all' || 
                    video.subcategory === currentSubcategory;
                
                const matchesFormat = currentFormat === 'all' || 
                    video.format === currentFormat;
                
                const matchesSearch = !searchTerm || 
                    video.title.toLowerCase().includes(searchTerm) ||
                    video.category.toLowerCase().includes(searchTerm) ||
                    video.subcategory.toLowerCase().includes(searchTerm) ||
                    video.description.toLowerCase().includes(searchTerm) ||
                    video.tags.toLowerCase().includes(searchTerm);
                
                return matchesCategory && matchesSubcategory && matchesFormat && matchesSearch;
            });
            
            // Update result count
            const resultCount = document.getElementById('resultCount');
            if (resultCount) {
                resultCount.textContent = `${filteredVideos.length} video${filteredVideos.length !== 1 ? 's' : ''} found`;
            }
            
            renderVideos(true);
        }

        function openModal(video) {
            currentVideo = video;
            const modal = document.getElementById('previewModal');
            const videoPlayer = document.getElementById('modalVideo');
            const videoContainer = videoPlayer.parentElement;
            
            document.getElementById('modalTitle').innerText = video.title;
            document.getElementById('modalCategory').innerText = video.category;
            document.getElementById('modalSubcategory').innerText = video.subcategory || 'N/A';
            document.getElementById('modalFormat').innerText = video.format;
            document.getElementById('modalResolution').innerText = video.resolution;
            document.getElementById('modalPrice').innerText = video.price;
            document.getElementById('modalDescription').innerText = video.description;
            
            // Display tags
            const tagsContainer = document.getElementById('modalTags');
            tagsContainer.innerHTML = '';
            if (video.tags) {
                const tagArray = video.tags.split(',').map(t => t.trim()).filter(t => t);
                tagArray.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs';
                    tagEl.innerText = tag;
                    tagsContainer.appendChild(tagEl);
                });
            }
            
            if (video.preview) {
                console.log('üé¨ Loading video:', video.preview);
                
                // Remove any existing iframe
                const existingIframe = document.getElementById('modalIframe');
                if (existingIframe) existingIframe.remove();
                
                // Show video player with direct download URL
                videoPlayer.style.display = 'block';
                videoPlayer.src = video.preview;
                
                // Add loading state
                videoPlayer.addEventListener('loadstart', function() {
                    console.log('üì• Video loading started...');
                });
                
                videoPlayer.addEventListener('canplay', function() {
                    console.log('‚úÖ Video ready to play');
                });
                
                videoPlayer.addEventListener('error', function(e) {
                    console.error('‚ùå Video error:', e);
                    videoPlayer.style.display = 'none';
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'flex flex-col items-center justify-center aspect-video bg-gray-900 text-white';
                    errorDiv.innerHTML = `
                        <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg mb-2">Unable to load preview</p>
                        <p class="text-sm text-gray-400 mb-4">Google Drive may still be processing this video</p>
                        <a href="${video.preview}" download target="_blank" class="bg-teal-500 px-6 py-2 rounded-lg hover:bg-teal-600">
                            Download to View
                        </a>
                    `;
                    videoContainer.appendChild(errorDiv);
                });
                
                // Try to play
                videoPlayer.play().catch(err => {
                    console.warn('‚ö†Ô∏è Autoplay prevented (normal browser behavior)');
                });
                
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            } else {
                alert('Preview not available for this footage.');
            }
        }

        function closeModal() {
            const modal = document.getElementById('previewModal');
            const videoPlayer = document.getElementById('modalVideo');
            const iframe = document.getElementById('modalIframe');
            const loadingDiv = document.getElementById('videoLoading');
            
            videoPlayer.pause();
            videoPlayer.src = "";
            
            if (iframe) {
                iframe.src = "";
                iframe.remove();
            }
            
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-hidden');
        }

        function handlePurchase() {
            alert(`Payment integration coming soon!\n\nYou selected: ${currentVideo.title}\nPrice: $${currentVideo.price}`);
        }

        // Close modal on escape
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Initialize
        init();
    </script>
</body>
</html>
