 modal = document.getElementById('previewModal');
            const videoPlayer = document.getElementById('modalVideo');
            
            document.getElementById('modalTitle').innerText = video.title;
            document.getElementById('modalCategory').innerText = video.category;
            document.getElementById('modalSubcategory').innerText = video.subcategory || 'N/A';
            document.getElementById('modalSub').innerText = video.sub || 'N/A';
            document.getElementById('modalFormat').innerText = video.format;
            document.getElementById('modalResolution').innerText = video.resolution;
            document.getElementById('modalPrice').innerText = video.price;
            document.getElementById('modalDescription').innerText = video.description;
            
            const tagsContainer = document.getElementById('modalTags');
            tagsContainer.innerHTML = '';
            if (video.tags) {
                const tagArray = video.tags.split(',').map(t => t.trim()).filter(t => t);
                tagArray.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs';
                    tagEl.innerText = tag;
                    tagsContainer.appendChild(tagEl);
                });
            }
            
            if (video.preview) {
                videoPlayer.style.display = 'block';
                videoPlayer.src = video.preview;
                videoPlayer.play().catch(err => {
                    console.log('ℹ️ Autoplay blocked - user will click play');
                });
                
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            } else {
                alert('Preview not available for this footage.');
            }
        }

        function closeModal() {
            const modal = document.getElementById('previewModal');
            const videoPlayer = document.getElementById('modalVideo');
            
            videoPlayer.pause();
            videoPlayer.src = "";
            
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-hidden');
        }

        function handlePurchase() {
            if (!currentUser.isLoggedIn) {
                closeModal();
                showLoginModal();
                showNotification('Please sign in to purchase');
                return;
            }
            
            const price = parseFloat(currentVideo.price);
            
            if (currentUser.wallet < price) {
                const shortage = price - currentUser.wallet;
                showNotification(`Insufficient funds! You need $${shortage.toFixed(2)} more.`, 'error');
                closeModal();
                showTopUpModal();
                return;
            }
            
            if (confirm(`Purchase "${currentVideo.title}" for $${price.toFixed(2)}?`)) {
                showNotification('Purchase feature coming soon!');
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // ============================================
        // WALLET FUNCTIONS
        // ============================================

        // Update wallet display
        function updateWalletDisplay() {
            const loginButton = document.getElementById('loginButton');
            const walletDisplay = document.getElementById('walletDisplay');
            const walletAmount = document.getElementById('walletAmount');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            
            if (currentUser.isLoggedIn) {
                loginButton.style.display = 'none';
                walletDisplay.style.display = 'block';
                walletAmount.textContent = '$' + currentUser.wallet.toFixed(2);
                userEmailDisplay.textContent = currentUser.email;
            } else {
                loginButton.style.display = 'block';
                walletDisplay.style.display = 'none';
            }
        }

        // Toggle user menu
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const menuButton = document.getElementById('userMenuButton');
            const menu = document.getElementById('userMenu');
            
            if (menu && menuButton && !menuButton.contains(event.target) && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        // Show login modal
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        // Close login modal
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('userEmail').value;
            const newsletter = document.getElementById('newsletterCheckbox').checked;
            
            localStorage.setItem(WALLET_CONFIG.STORAGE_KEY, email);
            
            await loadUserData(email);
            
            closeLoginModal();
            
            showNotification('Welcome! Your wallet: $' + currentUser.wallet.toFixed(2));
            
            updateWalletDisplay();
        }

        // Load user data from Apps Script
        async function loadUserData(email) {
            try {
                const url = `${WALLET_CONFIG.API_URL}?action=getUser&email=${encodeURIComponent(email)}`;
                const response = await fetch(url);
                const user = await response.json();
                
                if (user && user.email) {
                    currentUser = {
                        email: user.email,
                        wallet: user.wallet || 0,
                        isLoggedIn: true
                    };
                } else {
                    currentUser = {
                        email: email,
                        wallet: 0,
                        isLoggedIn: true
                    };
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading user data', 'error');
            }
        }

        // Check if user is already logged in (on page load)
        async function checkLoginStatus() {
            const savedEmail = localStorage.getItem(WALLET_CONFIG.STORAGE_KEY);
            
            if (savedEmail) {
                await loadUserData(savedEmail);
                updateWalletDisplay();
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem(WALLET_CONFIG.STORAGE_KEY);
            currentUser = {
                email: null,
                wallet: 0,
                isLoggedIn: false
            };
            updateWalletDisplay();
            showNotification('Logged out successfully');
        }

        // Show top-up modal
        function showTopUpModal() {
            if (!currentUser.isLoggedIn) {
                showLoginModal();
                return;
            }
            
            document.getElementById('topUpModal').style.display = 'block';
        }

        // Close top-up modal
        function closeTopUpModal() {
            document.getElementById('topUpModal').style.display = 'none';
        }

        // Add funds to wallet
        async function addFunds(amount) {
            if (!currentUser.isLoggedIn) {
                showLoginModal();
                return;
            }
            
            try {
                showNotification('Creating checkout session...');
                
                const url = `${WALLET_CONFIG.API_URL}?action=createCheckout&email=${encodeURIComponent(currentUser.email)}&amount=${amount}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.url) {
                    window.location.href = result.url;
                } else {
                    showNotification('Error: ' + (result.error || 'Failed to create checkout'), 'error');
                }
                
            } catch (error) {
                console.error('Error creating checkout:', error);
                showNotification('Error creating checkout session', 'error');
            }
        }

        // Handle successful payment (check URL params)
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('success') === 'true') {
                setTimeout(async () => {
                    if (currentUser.email) {
                        await loadUserData(currentUser.email);
                        updateWalletDisplay();
                        showNotification('✅ Payment successful! Your wallet has been updated.', 'success');
                    }
                }, 1000);
                
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (urlParams.get('canceled') === 'true') {
                showNotification('Payment canceled', 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            
            if (type === 'error') {
                notification.style.background = '#EF4444';
            } else if (type === 'success') {
                notification.style.background = '#10B981';
            } else {
                notification.style.background = '#14B8A6';
            }
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Placeholder for purchase history
        function showPurchaseHistory() {
            showNotification('Purchase history feature coming soon!');
            document.getElementById('userMenu').style.display = 'none';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', checkLoginStatus);
        init();
    </script>
</body>
</html>
